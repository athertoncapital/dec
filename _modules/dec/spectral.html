<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>dec.spectral &mdash; dec  documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="dec  documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="../../index.html">dec  documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for dec.spectral</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Spectral DEC</span>
<span class="sd">=============</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">dec.helper</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">numpy.testing</span> <span class="kn">import</span> <span class="n">assert_almost_equal</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="nb">reduce</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">scipy.linalg.special_matrices</span> <span class="kn">import</span> <span class="n">toeplitz</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">scipy.linalg.basic</span> <span class="kn">import</span> <span class="n">toeplitz</span>

<span class="n">seterr</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s">&#39;ignore&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="alpha0"><a class="viewcode-back" href="../../bases.html#dec.spectral.alpha0">[docs]</a><span class="k">def</span> <span class="nf">alpha0</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    .. math::</span>
<span class="sd">        \alpha_{N}(x)=\frac{1}{N}</span>
<span class="sd">        \begin{cases}</span>
<span class="sd">            \cot\frac{x}{2}\,\sin\frac{Nx}{2} &amp; \text{if N even,}\\</span>
<span class="sd">            \csc\frac{x}{2}\,\sin\frac{Nx}{2} &amp; \text{if N odd.}</span>
<span class="sd">        \end{cases}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">N</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">tan</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">N</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">N</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="s">&#39;__setitem__&#39;</span><span class="p">):</span>
        <span class="n">y</span><span class="p">[</span><span class="n">x</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">y</span>
</div>
<div class="viewcode-block" id="beta0"><a class="viewcode-back" href="../../bases.html#dec.spectral.beta0">[docs]</a><span class="k">def</span> <span class="nf">beta0</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    .. math::</span>
<span class="sd">        \beta_{N}(x)=</span>
<span class="sd">        \begin{cases}</span>
<span class="sd">            \frac{1}{2\pi} -\frac{1}{4}\cos\frac{Nx}{2} +</span>
<span class="sd">                \frac{1}{N}\sum\limits_{n=1}^{N/2}</span>
<span class="sd">                    \frac{n\cos nx}{\sin\frac{n\pi}{N}} &amp; \text{if N even,}\\</span>
<span class="sd">            \frac{1}{2\pi} +</span>
<span class="sd">                \frac{1}{N}\sum\limits_{n=1}^{(N-1)/2}</span>
<span class="sd">                    \frac{n\cos nx}{\sin\frac{n\pi}{N}} &amp; \text{if N odd.}</span>
<span class="sd">        \end{cases}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">N</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span> <span class="o">-</span> <span class="n">cos</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">y</span> <span class="o">+=</span> <span class="n">n</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">sin</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">N</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span><span class="o">*</span><span class="n">x</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">y</span> <span class="o">+=</span> <span class="n">n</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">sin</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">N</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span>
    <span class="k">return</span> <span class="n">y</span>
</div>
<div class="viewcode-block" id="alpha"><a class="viewcode-back" href="../../bases.html#dec.spectral.alpha">[docs]</a><span class="k">def</span> <span class="nf">alpha</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    .. math::</span>
<span class="sd">        \alpha_{N, n} (x) = \alpha_N(x-h n)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">alpha0</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">x</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">N</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="beta"><a class="viewcode-back" href="../../bases.html#dec.spectral.beta">[docs]</a><span class="k">def</span> <span class="nf">beta</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    .. math::</span>
<span class="sd">        \beta_{N, n} (x) = \beta_N(x-h n)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">beta0</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">x</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">N</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="gamma"><a class="viewcode-back" href="../../bases.html#dec.spectral.gamma">[docs]</a><span class="k">def</span> <span class="nf">gamma</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    .. math::</span>
<span class="sd">        \gamma_{N, n} = \int_0^{\frac{h}{2}=\frac{\pi}{N}} \beta_{N,n}(x) \, dx =</span>
<span class="sd">        \begin{cases}</span>
<span class="sd">        \frac{1}{2N} -</span>
<span class="sd">        \frac{(-1)^k}{2N} +</span>
<span class="sd">        \frac{1}{N}\sum\limits_{n=1}^{N/2}</span>
<span class="sd">        \frac{\sin(2 k n \pi/N) - \sin((2 k-1) n \pi/N)}</span>
<span class="sd">        {\sin\frac{n\pi}{N}} &amp; \text{if N even,}\\</span>
<span class="sd">        \frac{1}{2N} +</span>
<span class="sd">        \frac{1}{N}\sum\limits_{n=1}^{(N-1)/2}</span>
<span class="sd">        \frac{\sin(2 k n \pi/N) - \sin((2 k-1) n \pi/N)}{\sin\frac{n\pi}{N}} &amp; \text{if N odd.}</span>
<span class="sd">        \end{cases}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">N</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">k</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">y</span> <span class="o">+=</span> <span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="o">*</span><span class="n">k</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">N</span><span class="p">)</span> <span class="o">-</span> <span class="n">sin</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">n</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">N</span><span class="p">))</span> <span class="o">/</span> <span class="n">sin</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">N</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">y</span> <span class="o">+=</span> <span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="o">*</span><span class="n">k</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">N</span><span class="p">)</span> <span class="o">-</span> <span class="n">sin</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">n</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">N</span><span class="p">))</span> <span class="o">/</span> <span class="n">sin</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">N</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span>
    <span class="k">return</span> <span class="n">y</span>

<span class="c">########################################</span>
<span class="c"># Periodic Basis Functions</span>
<span class="c">########################################</span>
</div>
<div class="viewcode-block" id="phi0"><a class="viewcode-back" href="../../bases.html#dec.spectral.phi0">[docs]</a><span class="k">def</span> <span class="nf">phi0</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Basis functions for primal 0-forms.</span>

<span class="sd">    .. math::</span>
<span class="sd">        \phi_{N,n}^{0}(x)=\alpha_{N,n}(x)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">alpha</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="phi1"><a class="viewcode-back" href="../../bases.html#dec.spectral.phi1">[docs]</a><span class="k">def</span> <span class="nf">phi1</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Basis functions for primal 1-forms.</span>

<span class="sd">    .. math::</span>
<span class="sd">        \phi_{N,n}^{1}(x)=\beta_{N,n+\frac{1}{2}}(x)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">beta</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="phid0"><a class="viewcode-back" href="../../bases.html#dec.spectral.phid0">[docs]</a><span class="k">def</span> <span class="nf">phid0</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Basis functions for dual 0-forms.</span>

<span class="sd">    .. math::</span>
<span class="sd">        \widetilde{\phi}_{N,n}^{0}(x)=\alpha_{N,n+\frac{1}{2}}(x)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">alpha</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="phid1"><a class="viewcode-back" href="../../bases.html#dec.spectral.phid1">[docs]</a><span class="k">def</span> <span class="nf">phid1</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Basis functions for dual 1-forms.</span>

<span class="sd">    .. math::</span>
<span class="sd">        \widetilde{\phi}_{N,n}^{1}(x)=\alpha_{N,n}(x)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">beta</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

<span class="c">########################################</span>
<span class="c"># Mapping between semi-circle and line #</span>
<span class="c">########################################</span>
</div>
<div class="viewcode-block" id="varphi"><a class="viewcode-back" href="../../bases.html#dec.spectral.varphi">[docs]</a><span class="k">def</span> <span class="nf">varphi</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    .. math::</span>
<span class="sd">        \varphi:&amp;&amp; [-1,1]\to[0,\pi]\\</span>
<span class="sd">                &amp;&amp; x\mapsto\arccos(-x)</span>

<span class="sd">    &gt;&gt;&gt; varphi(-1) == 0</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; varphi(+1) == pi</span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">arccos</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="varphi_inv"><a class="viewcode-back" href="../../bases.html#dec.spectral.varphi_inv">[docs]</a><span class="k">def</span> <span class="nf">varphi_inv</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    .. math::</span>
<span class="sd">        \varphi^{-1}:&amp;&amp; [0,\pi]\to[-1,1]\\</span>
<span class="sd">                &amp;&amp; \theta\mapsto-\cos(\theta)</span>

<span class="sd">    &gt;&gt;&gt; varphi_inv(0) == -1</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; varphi_inv(pi) == +1</span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c">############################################################</span>
<span class="c"># Regular Basis Functions</span>
<span class="c">############################################################</span>
</div>
<div class="viewcode-block" id="delta"><a class="viewcode-back" href="../../bases.html#dec.spectral.delta">[docs]</a><span class="k">def</span> <span class="nf">delta</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Basis function for dual half-edge at the boundary.</span>

<span class="sd">    .. math::</span>
<span class="sd">        \delta_{N}(x)=\left((N-1)^{2}\alpha_{2N-2,0}(x)+\frac{1}{2}\cos\left((N-1)x\right)\right)\sin(x)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">((</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">cos</span><span class="p">((</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="p">))</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="rho"><a class="viewcode-back" href="../../bases.html#dec.spectral.rho">[docs]</a><span class="k">def</span> <span class="nf">rho</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    .. math::</span>
<span class="sd">        \rho_{N, n}(x) = 2 \gamma_{2N-2, n}\delta_N(x) + 2 \gamma_{2N-2, N-n-1} \delta_N(\pi-x)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mi">2</span><span class="o">*</span><span class="n">gamma</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">delta</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">gamma</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="o">-</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">delta</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">pi</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="kappa0"><a class="viewcode-back" href="../../bases.html#dec.spectral.kappa0">[docs]</a><span class="k">def</span> <span class="nf">kappa0</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Basis functions for primal 0-forms.</span>

<span class="sd">    .. math::</span>
<span class="sd">        \kappa_{N,n}^{0}(x) =</span>
<span class="sd">        \begin{cases}</span>
<span class="sd">            \alpha_{2N-2,n}(x), &amp; n\in\{0,N-1\}\\</span>
<span class="sd">            \alpha_{2N-2,n}(x)+\alpha_{2N-2,2N-2-n}(x), &amp; n\in\{1,\dots,N-2\}</span>
<span class="sd">        \end{cases}</span>
<span class="sd">   &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span>  <span class="n">alpha</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">alpha</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">+</span>
                <span class="n">alpha</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="kappa1"><a class="viewcode-back" href="../../bases.html#dec.spectral.kappa1">[docs]</a><span class="k">def</span> <span class="nf">kappa1</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    .. math::</span>
<span class="sd">        \kappa_{N,n}^{1}(x) = \left(</span>
<span class="sd">        \beta_{2N-2,n+\frac{1}{2}}(x)-</span>
<span class="sd">        \beta_{2N-2,2N-3-n+\frac{1}{2}}(x)\right)</span>
<span class="sd">        \mathbf{d}x,n\in\{0,\dots,N-2\}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">beta</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span>
            <span class="n">beta</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">-</span><span class="mi">3</span><span class="o">-</span><span class="n">n</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="kappad0"><a class="viewcode-back" href="../../bases.html#dec.spectral.kappad0">[docs]</a><span class="k">def</span> <span class="nf">kappad0</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    .. math::</span>
<span class="sd">        \widetilde{\kappa}_{N,n}^{0}(x)=</span>
<span class="sd">        \alpha_{2N-2,\, n+\frac{1}{2}}(x)+</span>
<span class="sd">        \alpha_{2N-2,\,2N-3-n+\frac{1}{2}}(x),\quad n\in\{0,\dots,N-2\}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">alpha</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">alpha</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">-</span><span class="mi">3</span><span class="o">-</span><span class="n">n</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="kappad1"><a class="viewcode-back" href="../../bases.html#dec.spectral.kappad1">[docs]</a><span class="k">def</span> <span class="nf">kappad1</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    .. math::</span>
<span class="sd">        \widetilde{\kappa}_{N,n}^{1}(x)=</span>
<span class="sd">        \begin{cases}</span>
<span class="sd">            \delta(x)\mathbf{d}x &amp; \qquad n=0\\</span>
<span class="sd">            \left(\beta_{2N-2,n}(x)-\beta_{2N-2,2N-2-n}(x)-\rho_{N,n}(x)\right)\mathbf{d}x &amp; \qquad n\in\{1,\dots,N-2\}\\</span>
<span class="sd">            \delta(\pi-x)\mathbf{d}x &amp; \qquad n=N-1</span>
<span class="sd">        \end{cases}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">delta</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">delta</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">pi</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span>

    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">beta</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span>
         <span class="n">beta</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
         <span class="o">-</span> <span class="n">rho</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span>

<span class="c">############################################################</span>
<span class="c"># Chebyshev Basis Functions</span>
<span class="c"># They seem to be all polynomials:</span>
<span class="c"># &gt;&gt;&gt; x = linspace(-1, +1, 10000)</span>
<span class="c"># &gt;&gt;&gt; round_(polyfit(x, psid1(5, 5, x), 10), 3)[::-1]</span>
<span class="c"># array([ 0.125,  0.657, -2.177, -9.941, -5.121,  9.941,  7.877, -0.   ,</span>
<span class="c">#        -0.   ,  0.   ,  0.   ])</span>
<span class="c">############################################################</span>

<span class="c">#TODO: This is a dirty hack. Compute the limits explicilty?</span></div>
<span class="k">def</span> <span class="nf">__fix_singularity_at_boundary</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="c"># Avoid division by zero</span>
    <span class="c"># Make sure function has no side effects</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">is</span> <span class="n">ndarray</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">+=</span> <span class="p">(</span><span class="n">x</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-16</span> <span class="o">-</span> <span class="p">(</span><span class="n">x</span><span class="o">==+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-16</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span> <span class="n">x</span> <span class="o">+=</span> <span class="mf">1e-16</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">==+</span><span class="mi">1</span><span class="p">:</span> <span class="n">x</span> <span class="o">-=</span> <span class="mf">1e-16</span>
    <span class="k">return</span> <span class="n">x</span>

<div class="viewcode-block" id="psi0"><a class="viewcode-back" href="../../bases.html#dec.spectral.psi0">[docs]</a><span class="k">def</span> <span class="nf">psi0</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Basis functions for primal 0-forms.</span>

<span class="sd">    .. math::</span>
<span class="sd">        \psi_{N,n}^{0}(x)=\kappa_{N,n}^{0}(\arccos(-x))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">kappa0</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">arccos</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="psi1"><a class="viewcode-back" href="../../bases.html#dec.spectral.psi1">[docs]</a><span class="k">def</span> <span class="nf">psi1</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Basis functions for primal 1-forms.</span>

<span class="sd">    .. math::</span>
<span class="sd">        \psi_{N,n}^{1}(x)\mathbf{d}x=</span>
<span class="sd">            \kappa_{N,n}^{1}(\arccos(-x))\frac{\mathbf{d}x}{\sqrt{1-x^{2}}}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">__fix_singularity_at_boundary</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">kappa1</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">arccos</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">))</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="psid0"><a class="viewcode-back" href="../../bases.html#dec.spectral.psid0">[docs]</a><span class="k">def</span> <span class="nf">psid0</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Basis functions for dual 0-forms.</span>

<span class="sd">    .. math::</span>
<span class="sd">        \tilde{\psi}_{N,n}^{0}(x)=\tilde{\kappa}_{N,n}^{0}(\arccos(-x))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">kappad0</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">arccos</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="psid1"><a class="viewcode-back" href="../../bases.html#dec.spectral.psid1">[docs]</a><span class="k">def</span> <span class="nf">psid1</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Basis functions for dual 1-forms.</span>

<span class="sd">    .. math::</span>
<span class="sd">        \tilde{\psi}_{N,n}^{1}(x)\mathbf{d}x=\tilde{\kappa}_{N,n}^{1}(\arccos(-x))\frac{\mathbf{d}x}{\sqrt{1-x^{2}}}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">__fix_singularity_at_boundary</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">kappad1</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">arccos</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">))</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="c">###########################</span>
<span class="c"># Lagrange polynomials</span>
<span class="c">###########################</span>
</div>
<div class="viewcode-block" id="lagrange_polynomials"><a class="viewcode-back" href="../../bases.html#dec.spectral.lagrange_polynomials">[docs]</a><span class="k">def</span> <span class="nf">lagrange_polynomials</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Lagrange Polynomials for the set of points defined by :math:`x_m`.</span>
<span class="sd">    The Lagrange Polynomials are such that they are 1 at the point, and 0</span>
<span class="sd">    everywhere else.</span>

<span class="sd">    .. math::</span>
<span class="sd">        \psi_{n}^{0}(x)=\prod_{m=0,m\neq n}^{N-1}\frac{x-x_{m}}{x_{n}-x_{m}}</span>

<span class="sd">    &gt;&gt;&gt; L = lagrange_polynomials([0, 1, 2])</span>
<span class="sd">    &gt;&gt;&gt; [l(0) for l in L]</span>
<span class="sd">    [1.0, 0.0, -0.0]</span>
<span class="sd">    &gt;&gt;&gt; [l(1) for l in L]</span>
<span class="sd">    [-0.0, 1.0, 0.0]</span>
<span class="sd">    &gt;&gt;&gt; [l(2) for l in L]</span>
<span class="sd">    [0.0, -0.0, 1.0]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">L</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span><span class="o">*</span><span class="n">N</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">Li</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">):</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">))</span><span class="o">.</span><span class="n">difference</span><span class="p">([</span><span class="n">i</span><span class="p">]))</span>
            <span class="k">return</span> <span class="nb">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">mul</span><span class="p">,</span> <span class="n">gen</span><span class="p">)</span>
        <span class="n">L</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Li</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">L</span>
</div>
<span class="k">def</span> <span class="nf">freq</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &gt;&gt;&gt; freq(5)</span>
<span class="sd">    array([-2., -1.,  0.,  1.,  2.])</span>
<span class="sd">    &gt;&gt;&gt; freq(6)</span>
<span class="sd">    array([-3., -2., -1.,  0.,  1.,  2.])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="p">)</span>

<span class="n">F</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="n">Finv</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">method_in_fourier_space</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Finv</span><span class="p">(</span><span class="n">g</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">))</span>
    <span class="n">f</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">__doc__</span> <span class="c"># make sure doctests are run</span>
    <span class="k">return</span> <span class="n">f</span>

<div class="viewcode-block" id="H"><a class="viewcode-back" href="../../hodge-star.html#dec.spectral.H">[docs]</a><span class="k">def</span> <span class="nf">H</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    .. math::</span>
<span class="sd">        \mathbf{H}^0 = \widetilde{\mathbf{H}}^0 =</span>
<span class="sd">        \mathcal{F}^{-1} \mathbf{I}^{-\frac{h}{2}, \frac{h}{2}} \mathcal{F}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">N</span>
    <span class="k">return</span> <span class="n">Finv</span><span class="p">(</span> <span class="n">F</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">I_diag</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="o">-</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
</div>
<div class="viewcode-block" id="Hinv"><a class="viewcode-back" href="../../hodge-star.html#dec.spectral.Hinv">[docs]</a><span class="k">def</span> <span class="nf">Hinv</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    .. math::</span>
<span class="sd">        \mathbf{H}^1 = \widetilde{\mathbf{H}}^1 =</span>
<span class="sd">        \mathcal{F}^{-1}{\mathbf{I}^{-\frac{h}{2},\frac{h}{2}}}^{-1}\mathcal{F}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">N</span>
    <span class="k">return</span> <span class="n">Finv</span><span class="p">(</span> <span class="n">F</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="n">I_diag</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="o">-</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
</div>
<span class="k">def</span> <span class="nf">I</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">):</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Finv</span> <span class="p">(</span> <span class="n">I_diag</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="n">F</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="p">)</span>

<span class="k">def</span> <span class="nf">Iinv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">):</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Finv</span> <span class="p">(</span> <span class="n">F</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="n">I_diag</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span> <span class="p">)</span>

<span class="k">def</span> <span class="nf">S</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">N</span>
    <span class="k">return</span> <span class="n">Finv</span><span class="p">(</span> <span class="n">F</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">S_diag</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>

<span class="k">def</span> <span class="nf">Sinv</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">N</span>
    <span class="k">return</span> <span class="n">Finv</span><span class="p">(</span> <span class="n">F</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">S_diag</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="o">-</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>

<div class="viewcode-block" id="I_diag"><a class="viewcode-back" href="../../hodge-star.html#dec.spectral.I_diag">[docs]</a><span class="k">def</span> <span class="nf">I_diag</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    A diagonal matrix that corresponds to integration in Fourier space.</span>
<span class="sd">    Corresponds to :math:`f(x) \mapsto \int_{x+a}^{x+b} f(\xi) d\xi`</span>

<span class="sd">    .. math::</span>
<span class="sd">        \mathbf{I}_{\phantom{a,b}nn}^{a,b}</span>
<span class="sd">            =\frac{e^{inb}-e^{ina}}{in}</span>

<span class="sd">    .. math::</span>
<span class="sd">        \mathbf{I}_{\phantom{a,b}00}^{a,b}=b-a</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">freq</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">exp</span><span class="p">(</span><span class="mi">1j</span><span class="o">*</span><span class="n">n</span><span class="o">*</span><span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="n">exp</span><span class="p">(</span><span class="mi">1j</span><span class="o">*</span><span class="n">n</span><span class="o">*</span><span class="n">a</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">1j</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="n">y</span><span class="p">[</span><span class="n">n</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">a</span>
    <span class="k">return</span> <span class="n">y</span>
</div>
<div class="viewcode-block" id="S_diag"><a class="viewcode-back" href="../../hodge-star.html#dec.spectral.S_diag">[docs]</a><span class="k">def</span> <span class="nf">S_diag</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    A diagonal matrix that corresponds to shifting in Fourier Space</span>
<span class="sd">    Corresponds to :math:`f(x) \mapsto f(x-h)`</span>

<span class="sd">    .. math::</span>
<span class="sd">        \mathbf{S}_{\phantom{a}nn}^{a}=e^{ina}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">freq</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">exp</span><span class="p">(</span><span class="mi">1j</span><span class="o">*</span><span class="n">n</span><span class="o">*</span><span class="n">a</span><span class="p">)</span>
</div>
<span class="k">def</span> <span class="nf">fourier_I</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Corresponds to :math:`f(x) \mapsto \int_{x+a}^{x+b} f(\xi) d\xi`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">freq</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">exp</span><span class="p">(</span><span class="mi">1j</span><span class="o">*</span><span class="n">n</span><span class="o">*</span><span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="n">exp</span><span class="p">(</span><span class="mi">1j</span><span class="o">*</span><span class="n">n</span><span class="o">*</span><span class="n">a</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">1j</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="n">y</span><span class="p">[</span><span class="n">n</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">a</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="n">y</span>

<span class="k">def</span> <span class="nf">fourier_I_inv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">freq</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">exp</span><span class="p">(</span><span class="mi">1j</span><span class="o">*</span><span class="n">n</span><span class="o">*</span><span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="n">exp</span><span class="p">(</span><span class="mi">1j</span><span class="o">*</span><span class="n">n</span><span class="o">*</span><span class="n">a</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">1j</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="n">y</span><span class="p">[</span><span class="n">n</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">a</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">/</span><span class="n">y</span>

<span class="k">def</span> <span class="nf">fourier_T</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Corresponds to :math:`f(x) \mapsto f(x+a)`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">freq</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="mi">1j</span><span class="o">*</span><span class="n">n</span><span class="o">*</span><span class="n">h</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">fourier_J</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Corresponds to :math:`f(x) \mapsto \int_{x+a}^{x+b} f(\xi) \sin(\xi+c) d\xi`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">fourier_I</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">roll</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">*</span><span class="n">x</span><span class="p">,</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="mi">1j</span><span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="o">-</span> <span class="n">roll</span><span class="p">(</span><span class="n">c</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1j</span><span class="o">*</span><span class="n">c</span><span class="p">))</span><span class="o">/</span><span class="mi">2j</span>
    <span class="k">return</span> <span class="n">b</span>

<span class="k">def</span> <span class="nf">refine</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resample x at a twice refined grid.</span>
<span class="sd">    &gt;&gt;&gt; N = 4</span>
<span class="sd">    &gt;&gt;&gt; x = linspace(0, 2*pi, N+1)[:-1]</span>
<span class="sd">    &gt;&gt;&gt; y = linspace(0, 2*pi, 2*N+1)[:-1]</span>
<span class="sd">    &gt;&gt;&gt; approx(refine(cos(x)), cos(y))</span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">interweave</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">S</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">subdivide</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Subdivide x like below. Assume points are equidistant.</span>
<span class="sd">    *   *   *   *   *   *</span>
<span class="sd">    * * * * * * * * * * *</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span> <span class="k">return</span> <span class="n">x</span>
    <span class="k">assert</span> <span class="n">is_equidistant</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">interweave</span><span class="p">(</span><span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">diff</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">concatenate</span><span class="p">((</span><span class="n">y</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]))</span>

<span class="k">def</span> <span class="nf">integrate_spectral_coarse</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &gt;&gt;&gt; integrate_spectral_coarse(linspace(-pi, pi, 3), sin)</span>
<span class="sd">    array([-2.,  2.])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">is_equidistant</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">approx</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">x</span>
    <span class="n">f0</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">diff</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">real</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="n">f0</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">f1</span>

<span class="k">def</span> <span class="nf">integrate_spectral</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">is_equidistant</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">subdivide</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">integrate_spectral_coarse</span><span class="p">(</span><span class="n">r</span><span class="p">(</span><span class="n">r</span><span class="p">(</span><span class="n">r</span><span class="p">(</span><span class="n">x</span><span class="p">))),</span> <span class="n">f</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">f1</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="n">f1</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="n">f1</span><span class="p">[</span><span class="mi">2</span><span class="p">::</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="n">f1</span><span class="p">[</span><span class="mi">3</span><span class="p">::</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span>
            <span class="n">f1</span><span class="p">[</span><span class="mi">4</span><span class="p">::</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="n">f1</span><span class="p">[</span><span class="mi">5</span><span class="p">::</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="n">f1</span><span class="p">[</span><span class="mi">6</span><span class="p">::</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="n">f1</span><span class="p">[</span><span class="mi">7</span><span class="p">::</span><span class="mi">8</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">integrate_chebyshev</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &gt;&gt;&gt; integrate_chebyshev(array([cos(pi), cos(.5*pi), cos(0)]), lambda x: x)</span>
<span class="sd">    array([-0.5,  0.5])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">approx</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">xi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xi</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">xi</span>

    <span class="n">F</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">theta</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="o">-</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">varphi</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>

    <span class="k">assert</span><span class="p">(</span><span class="n">is_equidistant</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="c"># complete the circle from the other side</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">concatenate</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">pi</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">integrate_spectral</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">F</span><span class="p">)[:</span><span class="nb">len</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">integrate_chebyshev_dual</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Integrate points that may include the two half-edges at the boundary.</span>
<span class="sd">    #&gt;&gt;&gt; integrate_chebyshev_dual(array([cos(pi), cos(0.75*pi), cos(0.25*pi), cos(0)]), lambda x: x)</span>
<span class="sd">    #array([-0.25,  0.  ,  0.25])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">varphi</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">varphi_inv</span><span class="p">(</span><span class="n">concatenate</span><span class="p">(([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">subdivide</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])))</span>
    <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">concatenate</span><span class="p">((</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">integrate_chebyshev</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">f</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">i</span><span class="o">+</span><span class="n">j</span>

<span class="k">def</span> <span class="nf">split_args</span><span class="p">(</span><span class="n">I</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert integration function from I(x, f) to I(x0, x1, f) form</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">J</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">I</span><span class="o">=</span><span class="n">I</span><span class="p">):</span>
        <span class="n">assert_almost_equal</span><span class="p">(</span><span class="n">x0</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">x1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">I</span><span class="p">(</span><span class="n">concatenate</span><span class="p">((</span><span class="n">x0</span><span class="p">,</span> <span class="p">[</span><span class="n">x1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])),</span> <span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">J</span>

<span class="k">def</span> <span class="nf">hodge_star_matrix</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute Hodge-Star matrix from basis functions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">P0</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P0d</span><span class="p">,</span> <span class="n">P1d</span> <span class="o">=</span> <span class="n">P</span>
    <span class="n">B0</span><span class="p">,</span> <span class="n">B1</span><span class="p">,</span> <span class="n">B0d</span><span class="p">,</span> <span class="n">B1d</span> <span class="o">=</span> <span class="n">B</span>
    <span class="n">H0</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">(</span><span class="n">P1d</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">B0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">H1</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">(</span><span class="n">P0d</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">B1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">H0d</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">(</span><span class="n">P1</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">B0d</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">H1d</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">(</span><span class="n">P0</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">B1d</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">H0</span><span class="p">,</span> <span class="n">H1</span><span class="p">,</span> <span class="n">H0d</span><span class="p">,</span> <span class="n">H1d</span>

<span class="k">def</span> <span class="nf">reconstruction</span><span class="p">(</span><span class="n">basis_fn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Give the reconstruction functions for the set of basis functions basis_fn.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">summation</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">x</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">B</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">[(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">summation</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">B</span><span class="p">))</span> <span class="k">for</span> <span class="n">B</span> <span class="ow">in</span> <span class="n">basis_fn</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">Form</span><span class="p">(</span><span class="n">ndarray</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">input_array</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">primal</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">asarray</span><span class="p">(</span><span class="n">input_array</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">degree</span> <span class="o">=</span> <span class="n">degree</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">primal</span> <span class="o">=</span> <span class="n">primal</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="nf">__array_finalize__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&#39;grid&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">degree</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&#39;degree&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primal</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&#39;primal&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">DEC</span><span class="p">(</span><span class="n">grid</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    P, R, D, H = DEC(g)</span>
<span class="sd">    this function returns the usual dec operators which then select the appropriate</span>
<span class="sd">    specialization of the operator for the given form based on its order and whether</span>
<span class="sd">    it is primal or dual</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">ops_1D</span> <span class="o">=</span> <span class="n">operators</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">typed1</span><span class="p">(</span><span class="n">op</span><span class="p">):</span>
        <span class="n">by_codomain</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">ops_1D</span><span class="p">[</span><span class="n">op</span><span class="p">]:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">codomain</span> <span class="o">=</span> <span class="n">tup</span>
            <span class="n">by_codomain</span><span class="p">[</span><span class="n">codomain</span><span class="p">]</span> <span class="o">=</span> <span class="n">tup</span>
        <span class="k">def</span> <span class="nf">O</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">):</span>
            <span class="n">codomain</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
            <span class="n">f</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">by_codomain</span><span class="p">[</span><span class="n">codomain</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">Form</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">f</span><span class="p">)(</span><span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">grid</span><span class="p">,</span> <span class="o">*</span><span class="n">codomain</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">O</span>

    <span class="k">def</span> <span class="nf">typed2</span><span class="p">(</span><span class="n">op</span><span class="p">):</span>
        <span class="n">by_domain</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">ops_1D</span><span class="p">[</span><span class="n">op</span><span class="p">]:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">tup</span>
            <span class="n">by_domain</span><span class="p">[</span><span class="n">domain</span><span class="p">]</span> <span class="o">=</span> <span class="n">tup</span>
        <span class="k">def</span> <span class="nf">O</span><span class="p">(</span><span class="n">form</span><span class="p">):</span>
            <span class="s">&quot; Select appropriate operator for form&quot;</span>
            <span class="k">assert</span> <span class="n">grid</span> <span class="o">==</span> <span class="n">form</span><span class="o">.</span><span class="n">grid</span>
            <span class="n">f</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">codomain</span> <span class="o">=</span> <span class="n">by_domain</span><span class="p">[(</span><span class="n">form</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">primal</span><span class="p">)]</span>
            <span class="k">return</span> <span class="n">Form</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">f</span><span class="p">)(</span><span class="n">form</span><span class="p">),</span> <span class="n">grid</span><span class="p">,</span> <span class="o">*</span><span class="n">codomain</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">O</span>

    <span class="k">def</span> <span class="nf">typed3</span><span class="p">(</span><span class="n">op</span><span class="p">):</span>
        <span class="n">by_domain</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">ops_1D</span><span class="p">[</span><span class="n">op</span><span class="p">]:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">tup</span>
            <span class="n">by_domain</span><span class="p">[</span><span class="n">domain</span><span class="p">]</span> <span class="o">=</span> <span class="n">tup</span>
        <span class="k">def</span> <span class="nf">O</span><span class="p">(</span><span class="n">form</span><span class="p">):</span>
            <span class="s">&quot; Select appropriate operator for form&quot;</span>
            <span class="k">assert</span> <span class="n">grid</span> <span class="o">==</span> <span class="n">form</span><span class="o">.</span><span class="n">grid</span>
            <span class="n">f</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">by_domain</span><span class="p">[(</span><span class="n">form</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">primal</span><span class="p">)]</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">f</span><span class="p">)(</span><span class="n">form</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">O</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">typed1</span><span class="p">(</span><span class="s">&#39;P&#39;</span><span class="p">),</span>
            <span class="n">typed3</span><span class="p">(</span><span class="s">&#39;R&#39;</span><span class="p">),</span>
            <span class="n">typed2</span><span class="p">(</span><span class="s">&#39;D&#39;</span><span class="p">),</span>
            <span class="n">typed2</span><span class="p">(</span><span class="s">&#39;H&#39;</span><span class="p">))</span>

<div class="viewcode-block" id="operators"><a class="viewcode-back" href="../../index.html#dec.spectral.operators">[docs]</a><span class="k">def</span> <span class="nf">operators</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return all the operators for dimension n together with their domains and codomains.</span>

<span class="sd">    &gt;&gt;&gt; import pprint</span>
<span class="sd">    &gt;&gt;&gt; pprint.PrettyPrinter().pprint(operators(1))</span>
<span class="sd">    {&#39;D&#39;: [(&#39;D0&#39;, (0, True), (1, True)), (&#39;D0d&#39;, (0, False), (1, False))],</span>
<span class="sd">     &#39;H&#39;: [(&#39;H0&#39;, (0, True), (1, False)),</span>
<span class="sd">           (&#39;H0d&#39;, (0, False), (1, True)),</span>
<span class="sd">           (&#39;H1&#39;, (1, True), (0, False)),</span>
<span class="sd">           (&#39;H1d&#39;, (1, False), (0, True))],</span>
<span class="sd">     &#39;P&#39;: [(&#39;P0&#39;, None, (0, True)),</span>
<span class="sd">           (&#39;P0d&#39;, None, (0, False)),</span>
<span class="sd">           (&#39;P1&#39;, None, (1, True)),</span>
<span class="sd">           (&#39;P1d&#39;, None, (1, False))],</span>
<span class="sd">     &#39;R&#39;: [(&#39;R0&#39;, (0, True), None),</span>
<span class="sd">           (&#39;R0d&#39;, (0, False), None),</span>
<span class="sd">           (&#39;R1&#39;, (1, True), None),</span>
<span class="sd">           (&#39;R1d&#39;, (1, False), None)]}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="s">&#39;{0}{1}{2}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="s">&#39;d&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="c"># enumerate all the possible discrete forms</span>
    <span class="k">def</span> <span class="nf">P</span><span class="p">(</span><span class="n">tup</span><span class="p">):</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">=</span> <span class="n">tup</span><span class="p">;</span> <span class="k">return</span> <span class="p">(</span> <span class="n">name</span><span class="p">(</span><span class="s">&#39;P&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="bp">None</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">def</span> <span class="nf">R</span><span class="p">(</span><span class="n">tup</span><span class="p">):</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">=</span> <span class="n">tup</span><span class="p">;</span> <span class="k">return</span> <span class="p">(</span> <span class="n">name</span><span class="p">(</span><span class="s">&#39;R&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="bp">None</span> <span class="p">)</span>
    <span class="k">def</span> <span class="nf">D</span><span class="p">(</span><span class="n">tup</span><span class="p">):</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">=</span> <span class="n">tup</span><span class="p">;</span> <span class="k">return</span> <span class="p">(</span> <span class="n">name</span><span class="p">(</span><span class="s">&#39;D&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">def</span> <span class="nf">H</span><span class="p">(</span><span class="n">tup</span><span class="p">):</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">=</span> <span class="n">tup</span><span class="p">;</span> <span class="k">return</span> <span class="p">(</span> <span class="n">name</span><span class="p">(</span><span class="s">&#39;H&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">k</span><span class="p">,</span> <span class="ow">not</span> <span class="n">t</span><span class="p">)</span> <span class="p">)</span>
    <span class="c"># Add more operators here - Wedge, Contraction/Flat ?</span>
    <span class="n">forms</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)))</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">P</span><span class="o">=</span><span class="p">[</span><span class="n">P</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">forms</span><span class="p">],</span>
                <span class="n">R</span><span class="o">=</span><span class="p">[</span><span class="n">R</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">forms</span><span class="p">],</span>
                <span class="n">D</span><span class="o">=</span><span class="p">[</span><span class="n">D</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">forms</span> <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">n</span><span class="p">],</span>
                <span class="n">H</span><span class="o">=</span><span class="p">[</span><span class="n">H</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">forms</span><span class="p">])</span>
</div>
<span class="n">Grid_1D_Interface</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">        pnts,</span>
<span class="s">        xmin, xmax, lenx,</span>
<span class="s">        verts, verts_dual,</span>
<span class="s">        edges, edges_dual,</span>
<span class="s">        basis_fn,</span>
<span class="s">        B0, B1, B0d, B1d,</span>
<span class="s">        projection,</span>
<span class="s">        P0, P1, P0d, P1d,</span>
<span class="s">        reconstruction,</span>
<span class="s">        R0, R1, R0d, R1d,</span>
<span class="s">        derivative,</span>
<span class="s">        D0, D0d,</span>
<span class="s">        hodge_star,</span>
<span class="s">        H0, H1, H0d, H1d,</span>
<span class="s">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Grid_1D_Periodic"><a class="viewcode-back" href="../../index.html#dec.spectral.Grid_1D_Periodic">[docs]</a><span class="k">def</span> <span class="nf">Grid_1D_Periodic</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">):</span>

    <span class="k">assert</span> <span class="n">xmax</span> <span class="o">&gt;</span> <span class="n">xmin</span>

    <span class="n">dimension</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">pnts</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">lenx</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="n">pnts</span><span class="p">)</span>

    <span class="n">verts</span> <span class="o">=</span> <span class="n">pnts</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="p">(</span><span class="n">pnts</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">pnts</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="n">verts_dual</span> <span class="o">=</span> <span class="n">verts</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">delta</span>
    <span class="n">edges_dual</span> <span class="o">=</span> <span class="p">(</span><span class="n">roll</span><span class="p">(</span><span class="n">verts_dual</span><span class="p">,</span><span class="n">shift</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">verts_dual</span><span class="p">)</span>
    <span class="n">edges_dual</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">lenx</span>
    <span class="n">delta_dual</span> <span class="o">=</span> <span class="n">delta</span>

    <span class="n">V</span> <span class="o">=</span> <span class="n">verts</span>
    <span class="n">S0</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">V</span><span class="p">))</span>
    <span class="n">S1</span> <span class="o">=</span> <span class="p">(</span><span class="n">S0</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">S0</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="n">Vd</span> <span class="o">=</span> <span class="n">verts_dual</span>
    <span class="n">S0d</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Vd</span><span class="p">))</span>
    <span class="n">S1d</span> <span class="o">=</span> <span class="p">(</span><span class="n">S0d</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">S0d</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="n">P0</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="n">verts</span><span class="p">)</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">split_args</span><span class="p">(</span><span class="n">integrate_spectral</span><span class="p">)(</span>
                    <span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">f</span><span class="p">)</span>
    <span class="n">P0d</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="n">verts_dual</span><span class="p">)</span>
    <span class="n">P1d</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">split_args</span><span class="p">(</span><span class="n">integrate_spectral</span><span class="p">)(</span>
                    <span class="n">edges_dual</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edges_dual</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">projection</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">P0</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P0d</span><span class="p">,</span> <span class="n">P1d</span>

    <span class="n">B0</span> <span class="o">=</span> <span class="p">[</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">:</span> <span class="n">phi0</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="n">B1</span> <span class="o">=</span> <span class="p">[</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">:</span> <span class="n">phi1</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="n">B0d</span> <span class="o">=</span> <span class="p">[</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">:</span> <span class="n">phid0</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="n">B1d</span> <span class="o">=</span> <span class="p">[</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">:</span> <span class="n">phid1</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="k">def</span> <span class="nf">basis_fn</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">B0</span><span class="p">,</span> <span class="n">B1</span><span class="p">,</span> <span class="n">B0d</span><span class="p">,</span> <span class="n">B1d</span>

    <span class="n">R0</span><span class="p">,</span> <span class="n">R1</span><span class="p">,</span> <span class="n">R0d</span><span class="p">,</span> <span class="n">R1d</span> <span class="o">=</span> <span class="n">reconstruction</span><span class="p">(</span><span class="n">basis_fn</span><span class="p">())</span>

    <span class="n">D0</span>  <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">roll</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">shift</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">f</span>
    <span class="n">D0d</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">roll</span><span class="p">(</span><span class="n">D0</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">shift</span><span class="o">=+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">derivative</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">D0</span><span class="p">,</span> <span class="n">D0d</span>

    <span class="n">H0</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">real</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">H1</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">real</span><span class="p">(</span><span class="n">Hinv</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">H0d</span> <span class="o">=</span> <span class="n">H0</span>
    <span class="n">H1d</span> <span class="o">=</span> <span class="n">H1</span>
    <span class="k">def</span> <span class="nf">hodge_star</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">H0</span><span class="p">,</span> <span class="n">H1</span><span class="p">,</span> <span class="n">H0d</span><span class="p">,</span> <span class="n">H1d</span>

    <span class="k">def</span> <span class="nf">derivative_matrix</span><span class="p">():</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">ons</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">row_stack</span><span class="p">((</span>
                   <span class="n">column_stack</span><span class="p">((</span>
                     <span class="n">rng</span><span class="p">,</span>
                     <span class="n">roll</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                     <span class="o">+</span><span class="n">ons</span><span class="p">)),</span>
                   <span class="n">column_stack</span><span class="p">((</span>
                     <span class="n">rng</span><span class="p">,</span>
                     <span class="n">rng</span><span class="p">,</span>
                     <span class="o">-</span><span class="n">ons</span><span class="p">))</span>
                   <span class="p">))</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">sparse_matrix</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">D</span><span class="p">,</span> <span class="o">-</span><span class="n">D</span><span class="o">.</span><span class="n">T</span>

    <span class="k">def</span> <span class="nf">differentiation_toeplitz</span><span class="p">():</span>
        <span class="k">raise</span> <span class="bp">NotImplemented</span>
        <span class="c">#TODO: fix this implementation</span>
        <span class="n">h</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">n</span>
        <span class="k">assert</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">column</span> <span class="o">=</span> <span class="n">concatenate</span><span class="p">((</span> <span class="p">[</span> <span class="mi">0</span> <span class="p">],</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="n">tan</span><span class="p">(</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>  <span class="p">))</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">concatenate</span><span class="p">((</span> <span class="n">column</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="n">column</span><span class="p">[</span><span class="mi">1</span><span class="p">:][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">))</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">toeplitz</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">D</span>

    <span class="k">def</span> <span class="nf">hodge_star_toeplitz</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The Hodge-Star using a Toeplitz matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">column</span> <span class="o">=</span> <span class="n">P1d</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">alpha0</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">concatenate</span><span class="p">((</span><span class="n">column</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="n">column</span><span class="p">[</span><span class="mi">1</span><span class="p">:][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">toeplitz</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">wedge</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return \alpha ^ \beta. Keep only for primal forms for now.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">w00</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">beta</span>
        <span class="k">def</span> <span class="nf">_w01</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">S</span><span class="p">(</span><span class="n">H</span><span class="p">(</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">Hinv</span><span class="p">(</span><span class="n">Sinv</span><span class="p">(</span><span class="n">beta</span><span class="p">))</span> <span class="p">))</span>
        <span class="k">def</span> <span class="nf">w01</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">):</span>
<span class="c">#            a = interweave(alpha, T(alpha, [S]))</span>
<span class="c">#            b = interweave(T(beta, [Hinv, Sinv]), T(beta, [Hinv]))</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">refine</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">refine</span><span class="p">(</span><span class="n">Hinv</span><span class="p">(</span><span class="n">Sinv</span><span class="p">(</span><span class="n">beta</span><span class="p">)))</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">S</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">w00</span><span class="p">,</span> <span class="n">w01</span><span class="p">,</span> <span class="n">_w01</span>

    <span class="k">def</span> <span class="nf">contraction</span><span class="p">(</span><span class="n">V</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return i_V. Keep only for primal forms for now.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">C1</span><span class="p">(</span><span class="n">alpha</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Hinv</span><span class="p">(</span><span class="n">Sinv</span><span class="p">(</span><span class="n">V</span><span class="p">))</span> <span class="o">*</span> <span class="n">Hinv</span><span class="p">(</span><span class="n">Sinv</span><span class="p">(</span><span class="n">alpha</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">C1</span>

    <span class="k">return</span> <span class="n">bunch</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
</div>
<span class="k">def</span> <span class="nf">_slow_integration</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">quad</span>
    <span class="k">return</span> <span class="n">array</span><span class="p">([</span><span class="n">quad</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">_a</span><span class="p">,</span> <span class="n">_b</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_a</span><span class="p">,</span> <span class="n">_b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)])</span>

<div class="viewcode-block" id="A_diag"><a class="viewcode-back" href="../../hodge-star.html#dec.spectral.A_diag">[docs]</a><span class="k">def</span> <span class="nf">A_diag</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    .. math::</span>
<span class="sd">        \mathbf{A}=\text{diag}\left(\begin{array}{ccccccc}\frac{1}{2} &amp; 1 &amp; 1 &amp; \dots &amp; 1 &amp; 1 &amp; \frac{1}{2}\end{array}\right)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">concatenate</span><span class="p">(([</span><span class="mf">0.5</span><span class="p">],</span> <span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="p">),</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">d</span>
</div>
<div class="viewcode-block" id="H0_regular"><a class="viewcode-back" href="../../hodge-star.html#dec.spectral.H0_regular">[docs]</a><span class="k">def</span> <span class="nf">H0_regular</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    .. math::</span>
<span class="sd">        \mathbf{H}^{0}=</span>
<span class="sd">            \mathbf{A}</span>
<span class="sd">            \mathbf{M}_{0}^{\dagger}</span>
<span class="sd">            \mathbf{I}^{-\frac{h}{2},\frac{h}{2}}</span>
<span class="sd">            \mathbf{M}_{0}^{+}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">mirror0</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">N</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">I_space</span><span class="p">(</span><span class="o">-</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">unmirror0</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">*</span><span class="n">A_diag</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span>  <span class="n">real</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="H1_regular"><a class="viewcode-back" href="../../hodge-star.html#dec.spectral.H1_regular">[docs]</a><span class="k">def</span> <span class="nf">H1_regular</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    .. math::</span>
<span class="sd">        \mathbf{H}^{1}=</span>
<span class="sd">            \mathbf{M}_{1}^{\dagger}</span>
<span class="sd">            {\mathbf{I}^{-\frac{h}{2},\frac{h}{2}}}^{-1}</span>
<span class="sd">            \mathbf{M}_{1}^{-}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">mirror1</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">N</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">I_space_inv</span><span class="p">(</span><span class="o">-</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">unmirror1</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span>
</div>
<div class="viewcode-block" id="H0d_regular"><a class="viewcode-back" href="../../hodge-star.html#dec.spectral.H0d_regular">[docs]</a><span class="k">def</span> <span class="nf">H0d_regular</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    .. math::</span>
<span class="sd">        \widetilde{\mathbf{H}}^{0}=</span>
<span class="sd">            \mathbf{M}_{1}^{\dagger}</span>
<span class="sd">            \mathbf{I}^{-\frac{h}{2},\frac{h}{2}}</span>
<span class="sd">            \mathbf{M}_{1}^{-}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">mirror1</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">N</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">I_space</span><span class="p">(</span><span class="o">-</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">unmirror1</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span>
</div>
<div class="viewcode-block" id="H1d_regular"><a class="viewcode-back" href="../../hodge-star.html#dec.spectral.H1d_regular">[docs]</a><span class="k">def</span> <span class="nf">H1d_regular</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    .. math::</span>
<span class="sd">        \widetilde{\mathbf{H}}^{1}=</span>
<span class="sd">            \mathbf{M}_{1}^{\dagger}</span>
<span class="sd">            {\mathbf{I}^{-\frac{h}{2},\frac{h}{2}}}^{-1}</span>
<span class="sd">            \mathbf{M}_{1}^{+}</span>
<span class="sd">            \mathbf{A}^{-1}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">/</span><span class="n">A_diag</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">mirror0</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">N</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">I_space_inv</span><span class="p">(</span><span class="o">-</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">+</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">unmirror0</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span>
</div>
<div class="viewcode-block" id="Grid_1D_Regular"><a class="viewcode-back" href="../../index.html#dec.spectral.Grid_1D_Regular">[docs]</a><span class="k">def</span> <span class="nf">Grid_1D_Regular</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="n">pi</span><span class="p">):</span>

    <span class="k">assert</span> <span class="n">xmax</span> <span class="o">&gt;</span> <span class="n">xmin</span>

    <span class="n">dimension</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">N</span> <span class="o">=</span> <span class="n">n</span>
    <span class="n">pnts</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
    <span class="n">lenx</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="n">pnts</span><span class="p">)</span>

    <span class="n">verts</span> <span class="o">=</span> <span class="n">pnts</span>
    <span class="n">verts_dual</span> <span class="o">=</span> <span class="n">verts</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">delta</span>

    <span class="n">edges</span> <span class="o">=</span> <span class="p">(</span><span class="n">pnts</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">pnts</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">concatenate</span><span class="p">(([</span><span class="n">xmin</span><span class="p">],</span> <span class="n">verts_dual</span><span class="p">,</span> <span class="p">[</span><span class="n">xmax</span><span class="p">]))</span>
    <span class="n">delta_dual</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
    <span class="n">edges_dual</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="n">P0</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="n">verts</span><span class="p">)</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">_slow_integration</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">f</span><span class="p">)</span>
    <span class="n">P0d</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="n">verts_dual</span><span class="p">)</span>
    <span class="n">P1d</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">_slow_integration</span><span class="p">(</span><span class="n">edges_dual</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edges_dual</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">projection</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">P0</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P0d</span><span class="p">,</span> <span class="n">P1d</span>

    <span class="n">B0</span> <span class="o">=</span> <span class="p">[</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">:</span> <span class="n">kappa0</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="n">B1</span> <span class="o">=</span> <span class="p">[</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">:</span> <span class="n">kappa1</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">B0d</span> <span class="o">=</span> <span class="p">[</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">:</span> <span class="n">kappad0</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">B1d</span> <span class="o">=</span> <span class="p">[</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">:</span> <span class="n">kappad1</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="k">def</span> <span class="nf">basis_fn</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">B0</span><span class="p">,</span> <span class="n">B1</span><span class="p">,</span> <span class="n">B0d</span><span class="p">,</span> <span class="n">B1d</span>

    <span class="n">R0</span><span class="p">,</span> <span class="n">R1</span><span class="p">,</span> <span class="n">R0d</span><span class="p">,</span> <span class="n">R1d</span> <span class="o">=</span> <span class="n">reconstruction</span><span class="p">(</span><span class="n">basis_fn</span><span class="p">())</span>

    <span class="n">D0</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">diff</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">D0d</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">diff</span><span class="p">(</span><span class="n">concatenate</span><span class="p">(([</span><span class="mi">0</span><span class="p">],</span> <span class="n">f</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
    <span class="k">def</span> <span class="nf">derivative</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">D0</span><span class="p">,</span> <span class="n">D0d</span>

    <span class="n">H0</span> <span class="o">=</span> <span class="n">H0_regular</span>
    <span class="n">H1</span> <span class="o">=</span> <span class="n">H1_regular</span>
    <span class="n">H0d</span> <span class="o">=</span> <span class="n">H0d_regular</span>
    <span class="n">H1d</span> <span class="o">=</span> <span class="n">H1d_regular</span>
    <span class="k">def</span> <span class="nf">hodge_star</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">H0</span><span class="p">,</span> <span class="n">H1</span><span class="p">,</span> <span class="n">H0d</span><span class="p">,</span> <span class="n">H1d</span>

    <span class="k">return</span> <span class="n">bunch</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="extend"><a class="viewcode-back" href="../../hodge-star.html#dec.spectral.extend">[docs]</a><span class="k">def</span> <span class="nf">extend</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    .. math::</span>
<span class="sd">        \mathbf{E}^{n}:\quad</span>
<span class="sd">        \begin{bmatrix}x_{0}\\</span>
<span class="sd">        \vdots\\</span>
<span class="sd">        x_{N-1}</span>
<span class="sd">        \end{bmatrix}</span>
<span class="sd">        \mapsto</span>
<span class="sd">        \frac{N+2n}{N}</span>
<span class="sd">        \begin{bmatrix}\left.\begin{array}{c}</span>
<span class="sd">        0\\</span>
<span class="sd">        \vdots\\</span>
<span class="sd">        0</span>
<span class="sd">        \end{array}\right\} n\\</span>
<span class="sd">        \begin{array}{c}</span>
<span class="sd">        x_{0}\\</span>
<span class="sd">        \vdots\\</span>
<span class="sd">        x_{N-1}</span>
<span class="sd">        \end{array}\\</span>
<span class="sd">        \left.\begin{array}{c}</span>
<span class="sd">        0\\</span>
<span class="sd">        \vdots\\</span>
<span class="sd">        0</span>
<span class="sd">        \end{array}\right\} n</span>
<span class="sd">        \end{bmatrix}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="o">/</span><span class="n">N</span><span class="o">*</span><span class="n">_extend</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="unextend"><a class="viewcode-back" href="../../hodge-star.html#dec.spectral.unextend">[docs]</a><span class="k">def</span> <span class="nf">unextend</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    .. math::</span>
<span class="sd">        \mathbf{E}^{-n}:\quad\begin{bmatrix}\left.\begin{array}{c}</span>
<span class="sd">        x_{-n}\\</span>
<span class="sd">        \vdots\\</span>
<span class="sd">        x_{-1}</span>
<span class="sd">        \end{array}\right\} n\\</span>
<span class="sd">        \begin{array}{c}</span>
<span class="sd">        x_{0}\\</span>
<span class="sd">        \vdots\\</span>
<span class="sd">        x_{N-1}</span>
<span class="sd">        \end{array}\\</span>
<span class="sd">        \left.\begin{array}{c}</span>
<span class="sd">        x_{N}\\</span>
<span class="sd">        \vdots\\</span>
<span class="sd">        x_{N+n-1}</span>
<span class="sd">        \end{array}\right\} n</span>
<span class="sd">        \end{bmatrix}\mapsto\frac{N-2n}{N}\begin{bmatrix}\left.\begin{array}{c}</span>
<span class="sd">        x_{0}+x_{N}\\</span>
<span class="sd">        \vdots\\</span>
<span class="sd">        x_{n-1}+x_{N+n-1}</span>
<span class="sd">        \end{array}\right\} n\\</span>
<span class="sd">        \begin{array}{c}</span>
<span class="sd">        x_{n}\\</span>
<span class="sd">        \vdots\\</span>
<span class="sd">        x_{N-n-1}</span>
<span class="sd">        \end{array}\\</span>
<span class="sd">        \left.\begin{array}{c}</span>
<span class="sd">        x_{N-n}+x_{-n}\\</span>
<span class="sd">        \vdots\\</span>
<span class="sd">        x_{N-1}+x_{-1}</span>
<span class="sd">        \end{array}\right\} n</span>
<span class="sd">        \end{bmatrix}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="o">/</span><span class="n">N</span><span class="o">*</span><span class="n">_unextend</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</div>
<span class="k">def</span> <span class="nf">_extend</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &gt;&gt;&gt; _extend([1, 2, 3, 4], 2)</span>
<span class="sd">    array([ 0.,  0.,  1.,  2.,  3.,  4.,  0.,  0.])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">concatenate</span><span class="p">((</span> <span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">),</span>
                         <span class="n">f</span><span class="p">,</span>
                         <span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">))</span>

<span class="k">def</span> <span class="nf">_unextend</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &gt;&gt;&gt; _unextend(array([0,0,1,2,3,4,0,0]), 2)</span>
<span class="sd">    array([1, 2, 3, 4])</span>
<span class="sd">    &gt;&gt;&gt; _unextend(array([1,2,0,0,3,4]), 2)</span>
<span class="sd">    array([4, 6])</span>
<span class="sd">    &gt;&gt;&gt; _unextend(array([0,1,2,3,4,5,6,7]), 2)</span>
<span class="sd">    array([ 8, 10,  4,  6])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="o">-</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">x</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>  <span class="o">+=</span> <span class="n">f</span><span class="p">[</span><span class="o">-</span><span class="n">n</span><span class="p">:]</span>
    <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="n">n</span><span class="p">:]</span> <span class="o">+=</span> <span class="n">f</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">x</span>

<div class="viewcode-block" id="mirror0"><a class="viewcode-back" href="../../hodge-star.html#dec.spectral.mirror0">[docs]</a><span class="k">def</span> <span class="nf">mirror0</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">sign</span><span class="o">=+</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    .. math::</span>
<span class="sd">        \mathbf{M}_{0}^{\pm}:\quad\begin{bmatrix}x_{0}\\</span>
<span class="sd">                x_{1}\\</span>
<span class="sd">                \vdots\\</span>
<span class="sd">                x_{N-2}\\</span>
<span class="sd">                x_{N-1}</span>
<span class="sd">            \end{bmatrix}\mapsto</span>
<span class="sd">            \begin{bmatrix}x_{0}\\</span>
<span class="sd">                x_{1}\\</span>
<span class="sd">                \vdots\\</span>
<span class="sd">                x_{N-2}\\</span>
<span class="sd">                x_{N-1}\\</span>
<span class="sd">                \pm x_{N-2}\\</span>
<span class="sd">                \vdots\\</span>
<span class="sd">                \pm x_{1}</span>
<span class="sd">            \end{bmatrix}</span>

<span class="sd">    &gt;&gt;&gt; mirror0(array([1, 2, 3]))</span>
<span class="sd">    array([1, 2, 3, 2])</span>
<span class="sd">    &gt;&gt;&gt; mirror0(array([1, 2, 3]), -1)</span>
<span class="sd">    array([ 1,  2,  3, -2])</span>
<span class="sd">    &gt;&gt;&gt; to_matrix(mirror0, 3)</span>
<span class="sd">    array([[ 1.,  0.,  0.],</span>
<span class="sd">           [ 0.,  1.,  0.],</span>
<span class="sd">           [ 0.,  0.,  1.],</span>
<span class="sd">           [ 0.,  1.,  0.]])</span>
<span class="sd">    &gt;&gt;&gt; to_matrix(lambda x: mirror0(x, -1), 3)</span>
<span class="sd">    array([[ 1.,  0.,  0.],</span>
<span class="sd">           [ 0.,  1.,  0.],</span>
<span class="sd">           [ 0.,  0.,  1.],</span>
<span class="sd">           [-0., -1., -0.]])</span>
<span class="sd">   &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">concatenate</span><span class="p">((</span><span class="n">f</span><span class="p">,</span> <span class="n">sign</span><span class="o">*</span><span class="n">f</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</div>
<div class="viewcode-block" id="mirror1"><a class="viewcode-back" href="../../hodge-star.html#dec.spectral.mirror1">[docs]</a><span class="k">def</span> <span class="nf">mirror1</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">sign</span><span class="o">=+</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    .. math::</span>
<span class="sd">        \mathbf{M}_{1}^{\pm}:\quad</span>
<span class="sd">        \begin{bmatrix}x_{0}\\</span>
<span class="sd">            x_{1}\\</span>
<span class="sd">            \vdots\\</span>
<span class="sd">            x_{N-2}\\</span>
<span class="sd">            x_{N-1}</span>
<span class="sd">        \end{bmatrix}\mapsto</span>
<span class="sd">        \begin{bmatrix}x_{0}\\</span>
<span class="sd">            x_{1}\\</span>
<span class="sd">            \vdots\\</span>
<span class="sd">            x_{N-2}\\</span>
<span class="sd">            x_{N-1}\\</span>
<span class="sd">            \pm x_{N-1}\\</span>
<span class="sd">            \pm x_{N-2}\\</span>
<span class="sd">            \vdots\\</span>
<span class="sd">            \pm x_{1}\\</span>
<span class="sd">            \pm x_{0}</span>
<span class="sd">        \end{bmatrix}</span>

<span class="sd">    &gt;&gt;&gt; mirror1(array([1, 2, 3]))</span>
<span class="sd">    array([1, 2, 3, 3, 2, 1])</span>
<span class="sd">    &gt;&gt;&gt; mirror1(array([1, 2, 3]), -1)</span>
<span class="sd">    array([ 1,  2,  3, -3, -2, -1])</span>
<span class="sd">    &gt;&gt;&gt; to_matrix(mirror1, 2)</span>
<span class="sd">    array([[ 1.,  0.],</span>
<span class="sd">           [ 0.,  1.],</span>
<span class="sd">           [ 0.,  1.],</span>
<span class="sd">           [ 1.,  0.]])</span>
<span class="sd">    &gt;&gt;&gt; to_matrix(lambda x: mirror1(x, -1), 2)</span>
<span class="sd">    array([[ 1.,  0.],</span>
<span class="sd">           [ 0.,  1.],</span>
<span class="sd">           [-0., -1.],</span>
<span class="sd">           [-1., -0.]])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">concatenate</span><span class="p">((</span><span class="n">f</span><span class="p">,</span> <span class="n">sign</span><span class="o">*</span><span class="n">f</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</div>
<div class="viewcode-block" id="unmirror0"><a class="viewcode-back" href="../../hodge-star.html#dec.spectral.unmirror0">[docs]</a><span class="k">def</span> <span class="nf">unmirror0</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    .. math::</span>
<span class="sd">        \mathbf{M}_{0}^{\dagger}:\quad\begin{bmatrix}x_{0}\\</span>
<span class="sd">        x_{1}\\</span>
<span class="sd">        \vdots\\</span>
<span class="sd">        x_{N-1}\\</span>
<span class="sd">        x_{N}\\</span>
<span class="sd">        \vdots\\</span>
<span class="sd">        x_{2N-1}</span>
<span class="sd">        \end{bmatrix}\mapsto\begin{bmatrix}x_{0}\\</span>
<span class="sd">        x_{1}\\</span>
<span class="sd">        \vdots\\</span>
<span class="sd">        x_{N-1}\\</span>
<span class="sd">        x_{N}\\</span>
<span class="sd">        x_{N+1}</span>
<span class="sd">        \end{bmatrix}</span>

<span class="sd">    &gt;&gt;&gt; unmirror0(array([1, 2, 3, 2]))</span>
<span class="sd">    array([1, 2, 3])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">[:(</span><span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
</div>
<div class="viewcode-block" id="unmirror1"><a class="viewcode-back" href="../../hodge-star.html#dec.spectral.unmirror1">[docs]</a><span class="k">def</span> <span class="nf">unmirror1</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    .. math::</span>
<span class="sd">        \mathbf{M}_{1}^{\dagger}:\quad\begin{bmatrix}x_{0}\\</span>
<span class="sd">        x_{1}\\</span>
<span class="sd">        \vdots\\</span>
<span class="sd">        x_{N-1}\\</span>
<span class="sd">        x_{N}\\</span>
<span class="sd">        \vdots\\</span>
<span class="sd">        x_{2N-1}</span>
<span class="sd">        \end{bmatrix}\mapsto\begin{bmatrix}x_{0}\\</span>
<span class="sd">        x_{1}\\</span>
<span class="sd">        \vdots\\</span>
<span class="sd">        x_{N-1}</span>
<span class="sd">        \end{bmatrix}</span>

<span class="sd">    &gt;&gt;&gt; unmirror1(array([1, 2, 3, -3, -2, -1]))</span>
<span class="sd">    array([1, 2, 3])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">[:(</span><span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)]</span>

<span class="c">#########</span>
<span class="c"># Methods using FFT</span>
<span class="c">#########</span>
</div>
<span class="k">def</span> <span class="nf">H_exp</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    :math:`\int_{x-h/2}^{x+h/2}f(\xi) \exp(i \xi) d\xi`</span>

<span class="sd">    This transformation is singular non-invertible.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">N</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">I_diag</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">roll</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Finv</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">H_sin</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    :math:`\int_{x-h/2}^{x+h/2}f(\xi) \sin(\xi) d\xi`</span>

<span class="sd">    This transformation is singular non-invertible.</span>

<span class="sd">    &gt;&gt;&gt; x = linspace(0, 2*pi, 6)[:-1]</span>
<span class="sd">    &gt;&gt;&gt; round_(real( H_sin(sin(2*x)) ), 3)</span>
<span class="sd">    array([ 0.271,  0.438, -0.573, -0.573,  0.438])</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">N</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">I_diag</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">roll</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">roll</span><span class="p">(</span><span class="n">c</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2j</span>

    <span class="k">return</span> <span class="n">Finv</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">H_sin_dual</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    :math:`\int_{x-h/2}^{x+h/2}f(\xi) \sin(\xi+\frac{h}{2}) d\xi`</span>

<span class="sd">    This transformation is singular non-invertible.</span>

<span class="sd">    &gt;&gt;&gt; x = linspace(0, 2*pi, 6)[:-1]</span>
<span class="sd">    &gt;&gt;&gt; round_(real( H_sin_dual(sin(2*x)) ), 3)</span>
<span class="sd">    array([ 0.219,  0.573, -0.084, -0.844,  0.135])</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">N</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">I_diag</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="mi">1j</span><span class="o">*</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">roll</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">s</span> <span class="o">-</span> <span class="n">roll</span><span class="p">(</span><span class="n">c</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">s</span><span class="p">)</span><span class="o">/</span><span class="mi">2j</span>

    <span class="k">return</span> <span class="n">Finv</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

<div class="viewcode-block" id="Omega"><a class="viewcode-back" href="../../hodge-star.html#dec.spectral.Omega">[docs]</a><span class="k">def</span> <span class="nf">Omega</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    .. math::</span>
<span class="sd">        \mathbf{\Omega}_{nn}=\sin\left(nh\right)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">h</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">N</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span> <span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">*</span><span class="n">h</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">o</span>
</div>
<div class="viewcode-block" id="Omega_d"><a class="viewcode-back" href="../../hodge-star.html#dec.spectral.Omega_d">[docs]</a><span class="k">def</span> <span class="nf">Omega_d</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    .. math::</span>
<span class="sd">        \mathbf{\widetilde{\Omega}}_{nn}</span>
<span class="sd">            =\sin\left(\left(n+\frac{1}{2}\right)h\right)</span>

<span class="sd">    If :math:`\widetilde{\omega}` is the length of each dual edge, then</span>

<span class="sd">    .. math::</span>
<span class="sd">        \mathbf{\widetilde{\Omega}}</span>
<span class="sd">            =\text{diag}(\mathbf{M}_{1}^{\dagger}</span>
<span class="sd">            \mathcal{F}^{-1}{\mathbf{I}^{-\frac{h}{2},\frac{h}{2}}}^{-1}</span>
<span class="sd">            \mathcal{F}\mathbf{M}_{1}^{-}\widetilde{\omega})</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">h</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">N</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span> <span class="p">(</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">h</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">o</span>
</div>
<div class="viewcode-block" id="half_edge_base"><a class="viewcode-back" href="../../hodge-star.html#dec.spectral.half_edge_base">[docs]</a><span class="k">def</span> <span class="nf">half_edge_base</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    This is the discrete version of :math:`\delta(x)` - the basis functions</span>
<span class="sd">    for the half edge at -1</span>

<span class="sd">    .. math::</span>
<span class="sd">        \mathbf{B}=</span>
<span class="sd">            \text{diag}\left(\underset{N}{\underbrace{</span>
<span class="sd">            (N-1)^{2},-\frac{1}{2},\frac{1}{2},-\frac{1}{2},\cdots}</span>
<span class="sd">            }\right)</span>

<span class="sd">    .. math::</span>
<span class="sd">        \mathbf{B}^\dagger=</span>
<span class="sd">            \text{diag}\left(\underset{N}{\underbrace{</span>
<span class="sd">            \cdots,-\frac{1}{2},\frac{1}{2},-\frac{1}{2},(N-1)^{2}}</span>
<span class="sd">            }\right)</span>


<span class="sd">    &gt;&gt;&gt; half_edge_base(3)</span>
<span class="sd">    array([ 4.5, -0.5,  0.5])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">a</span>
</div>
<span class="k">def</span> <span class="nf">half_edge_integrals</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &gt;&gt;&gt; approx( half_edge_integrals([1,0,0]), gamma(3, 0))</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; approx( half_edge_integrals([0,1,0]), gamma(3, 1))</span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">N</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">Hinv</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">I</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<div class="viewcode-block" id="pick"><a class="viewcode-back" href="../../hodge-star.html#dec.spectral.pick">[docs]</a><span class="k">def</span> <span class="nf">pick</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    Pick the nth element in the array f.</span>

<span class="sd">    .. math::</span>
<span class="sd">        \mathcal{\mathbf{P}}^{n}:\quad\begin{bmatrix}x_{0}\\</span>
<span class="sd">        \vdots\\</span>
<span class="sd">        x_{n-1}\\</span>
<span class="sd">        x_{n}\\</span>
<span class="sd">        x_{n+1}\\</span>
<span class="sd">        \vdots\\</span>
<span class="sd">        x_{N-1}</span>
<span class="sd">        \end{bmatrix}\mapsto\begin{bmatrix}x_{n}\\</span>
<span class="sd">        \vdots\\</span>
<span class="sd">        x_{n}\\</span>
<span class="sd">        x_{n}\\</span>
<span class="sd">        x_{n}\\</span>
<span class="sd">        \vdots\\</span>
<span class="sd">        x_{n}</span>
<span class="sd">        \end{bmatrix}</span>

<span class="sd">    .. math::</span>
<span class="sd">       \mathcal{\mathbf{P}}^{0}=\begin{pmatrix}1 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\</span>
<span class="sd">        1\\</span>
<span class="sd">        1\\</span>
<span class="sd">        1\\</span>
<span class="sd">        1</span>
<span class="sd">        \end{pmatrix},\quad\mathcal{\mathbf{P}}^{1}=\begin{pmatrix} 0 &amp; 1 &amp; 0 &amp; 0 &amp; 0\\</span>
<span class="sd">         &amp; 1\\</span>
<span class="sd">         &amp; 1\\</span>
<span class="sd">         &amp; 1\\</span>
<span class="sd">         &amp; 1</span>
<span class="sd">        \end{pmatrix},\dots</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">f</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">*</span><span class="n">ones</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

</div>
<span class="k">def</span> <span class="nf">reverse</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    Reverse array.</span>

<span class="sd">    .. math::</span>
<span class="sd">        \mathbf{R}:\quad\begin{bmatrix}x_{0}\\</span>
<span class="sd">        \vdots\\</span>
<span class="sd">        x_{n-1}\\</span>
<span class="sd">        x_{n}\\</span>
<span class="sd">        x_{n+1}\\</span>
<span class="sd">        \vdots\\</span>
<span class="sd">        x_{N-1}</span>
<span class="sd">        \end{bmatrix}\mapsto\begin{bmatrix}x_{N-1}\\</span>
<span class="sd">        \vdots\\</span>
<span class="sd">        x_{n+1}\\</span>
<span class="sd">        x_{n}\\</span>
<span class="sd">        x_{n-1}\\</span>
<span class="sd">        \vdots\\</span>
<span class="sd">        x_{0}</span>
<span class="sd">        \end{bmatrix}</span>

<span class="sd">    .. math::</span>
<span class="sd">        \mathbf{R} = \begin{pmatrix} &amp;  &amp;  &amp;  &amp; 1\\</span>
<span class="sd">         &amp;  &amp;  &amp; 1\\</span>
<span class="sd">         &amp;  &amp; 1\\</span>
<span class="sd">         &amp; 1\\</span>
<span class="sd">        1</span>
<span class="sd">        \end{pmatrix}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">I_space</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">Finv</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">*</span><span class="n">I_diag</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">I_space_inv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">Finv</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">/</span><span class="n">I_diag</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">T_space</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="k">return</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">Finv</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">*</span><span class="n">S_diag</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">a</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">T_space_inv</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="k">return</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">Finv</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">/</span><span class="n">S_diag</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">a</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">E_space</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">Finv</span><span class="p">(</span><span class="n">extend</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">n</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">E_space_inv</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">Finv</span><span class="p">(</span><span class="n">unextend</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">n</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">matA</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">concatenate</span><span class="p">((</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="p">))</span>

<span class="k">def</span> <span class="nf">matB</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">half_edge_base</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">b</span><span class="o">*</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">matB1</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">half_edge_base</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">b</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">f</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">matC</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">concatenate</span><span class="p">((</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">))</span>

<div class="viewcode-block" id="H0d_cheb"><a class="viewcode-back" href="../../hodge-star.html#dec.spectral.H0d_cheb">[docs]</a><span class="k">def</span> <span class="nf">H0d_cheb</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    .. math::</span>
<span class="sd">        \widetilde{\mathbf{H}}^0 = {\mathbf{M}_1}^{\dagger}</span>
<span class="sd">                \mathbf{I}^{-\frac{h}{2}, \frac{h}{2}}</span>
<span class="sd">                \widetilde{\mathbf{\Omega}} \mathbf{M}_1^+</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">mirror1</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">N</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">*</span><span class="n">Omega_d</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">I_space</span><span class="p">(</span><span class="o">-</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">unmirror1</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">f</span>
</div>
<div class="viewcode-block" id="H1_cheb"><a class="viewcode-back" href="../../hodge-star.html#dec.spectral.H1_cheb">[docs]</a><span class="k">def</span> <span class="nf">H1_cheb</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    .. math::</span>
<span class="sd">        \mathbf{H}^1 = {\mathbf{M}_1}^{\dagger}</span>
<span class="sd">                \widetilde{\mathbf{\Omega}}^{-1}</span>
<span class="sd">                {\mathbf{I}^{-\frac{h}{2}, \frac{h}{2}}}^{-1}</span>
<span class="sd">                \mathbf{M}_1^-</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">mirror1</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">N</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">I_space_inv</span><span class="p">(</span><span class="o">-</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">/</span><span class="n">Omega_d</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">unmirror1</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">f</span>
</div>
<div class="viewcode-block" id="H0_cheb"><a class="viewcode-back" href="../../hodge-star.html#dec.spectral.H0_cheb">[docs]</a><span class="k">def</span> <span class="nf">H0_cheb</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attempt to simplify the hodge-star.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">h</span> <span class="o">=</span> <span class="n">pi</span><span class="o">/</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">mirror0</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">E_space</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">I_space</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">)(</span><span class="n">f</span><span class="o">*</span><span class="n">Omega</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">unmirror1</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">matA</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">real</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</div>
<span class="k">def</span> <span class="nf">H0_cheb_alternate</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    .. math::</span>
<span class="sd">        \mathbf{H}^0 = \mathbf{M}_0^{\dagger}</span>
<span class="sd">            (\mathcal{A}^{0} \mathbf{E}^{-1} \mathbf{I}^{-\frac{h}{2}, 0} +</span>
<span class="sd">             \mathcal{A}^{N-1} \mathbf{E}^{-1} \mathbf{I}^{0, +\frac{h}{2}})</span>
<span class="sd">             \mathbf{\Omega} \mathbf{E}^{1}</span>
<span class="sd">             \mathbf{M}_0^{+}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">mirror0</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">E_space</span><span class="p">(</span><span class="mi">1</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">*</span><span class="n">Omega</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">I_space</span><span class="p">(</span><span class="o">-</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)(</span><span class="n">f</span><span class="p">),</span> <span class="n">I_space</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">E_space_inv</span><span class="p">(</span><span class="mi">1</span><span class="p">)(</span><span class="n">l</span><span class="p">),</span> <span class="n">E_space_inv</span><span class="p">(</span><span class="mi">1</span><span class="p">)(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">l</span><span class="o">+</span><span class="n">r</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">unmirror0</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="c">#TODO: Is it possible to avoid discarding the imaginary part?</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">real</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">return</span>  <span class="n">f</span>

<div class="viewcode-block" id="H1d_cheb"><a class="viewcode-back" href="../../hodge-star.html#dec.spectral.H1d_cheb">[docs]</a><span class="k">def</span> <span class="nf">H1d_cheb</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>

<span class="sd">    .. math::</span>

<span class="sd">        \widetilde{\mathbf{H}}^{1} = \mathbf{M}_{0}^{\dagger}\left(\mathbf{T^{-\frac{h}{2}}}\mathbf{\Omega}^{-1}\mathbf{T}^{\frac{h}{2}}-\mathbf{B}\mathbf{I}^{0,\frac{h}{2}}-\mathbf{B}^{\dagger}\mathbf{I}^{-\frac{h}{2},0}\right)\mathbf{I}^{-\frac{h}{2},\frac{h}{2}}^{-1}\mathbf{M}_{0}^{-}\mathbf{C}+\mathbf{B}+\mathbf{B}^{\dagger}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">h</span> <span class="o">=</span> <span class="n">pi</span><span class="o">/</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">half_edge_base</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">endpoints</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="n">mirror0</span><span class="p">(</span><span class="n">matC</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">aa</span> <span class="o">=</span> <span class="n">f</span> <span class="o">-</span> <span class="n">unmirror0</span><span class="p">(</span><span class="n">I_space</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">)(</span><span class="n">I_space_inv</span><span class="p">(</span><span class="o">-</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">)(</span><span class="n">f0</span><span class="p">)))</span>
        <span class="n">bb</span> <span class="o">=</span> <span class="n">f</span> <span class="o">-</span> <span class="n">unmirror0</span><span class="p">(</span><span class="n">I_space</span><span class="p">(</span><span class="o">-</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)(</span><span class="n">I_space_inv</span><span class="p">(</span><span class="o">-</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">)(</span><span class="n">f0</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">matB</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span> <span class="o">+</span> <span class="n">matB1</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">midpoints</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">mirror0</span><span class="p">(</span><span class="n">matC</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c"># Shift function with S, Sinv to avoid division by zero at x=0, x=pi</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">I_space_inv</span><span class="p">(</span><span class="o">-</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">T_space</span><span class="p">(</span><span class="o">+</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">/</span><span class="n">Omega_d</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">T_space</span><span class="p">(</span><span class="o">-</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">unmirror0</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span>
    <span class="k">return</span> <span class="n">midpoints</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">+</span> <span class="n">endpoints</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="laplacian"><a class="viewcode-back" href="../../poisson.html#dec.spectral.laplacian">[docs]</a><span class="k">def</span> <span class="nf">laplacian</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Laplacian Operator</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">D</span><span class="p">,</span> <span class="n">DD</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">derivative</span><span class="p">()</span>
    <span class="n">H0</span><span class="p">,</span> <span class="n">H1</span><span class="p">,</span> <span class="n">H0d</span><span class="p">,</span> <span class="n">H1d</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">hodge_star</span><span class="p">()</span>

    <span class="n">L</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">H1d</span><span class="p">(</span><span class="n">DD</span><span class="p">(</span><span class="n">H1</span><span class="p">(</span><span class="n">D</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span>
    <span class="n">Ld</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">H1</span><span class="p">(</span><span class="n">D</span><span class="p">(</span><span class="n">H1d</span><span class="p">(</span><span class="n">DD</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span>

    <span class="k">return</span> <span class="n">L</span><span class="p">,</span> <span class="n">Ld</span>
</div>
<div class="viewcode-block" id="Grid_1D_Chebyshev"><a class="viewcode-back" href="../../index.html#dec.spectral.Grid_1D_Chebyshev">[docs]</a><span class="k">def</span> <span class="nf">Grid_1D_Chebyshev</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=+</span><span class="mi">1</span><span class="p">):</span>

    <span class="n">N</span> <span class="o">=</span> <span class="n">n</span>
    <span class="n">dimension</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c"># 2n-1 points: n primal, n-1 dual</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">p</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">xmin</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">xmax</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">x</span><span class="p">))</span>

    <span class="n">verts</span> <span class="o">=</span> <span class="n">p</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="n">verts</span><span class="p">)</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="p">(</span><span class="n">verts</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">verts</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="n">verts_dual</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">concatenate</span><span class="p">(([</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">verts_dual</span><span class="p">,</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]))</span>
    <span class="n">delta_dual</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
    <span class="n">edges_dual</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="n">V</span> <span class="o">=</span> <span class="n">verts</span>
    <span class="n">S0</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">V</span><span class="p">))</span>
    <span class="n">S1</span> <span class="o">=</span> <span class="p">(</span><span class="n">S0</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">S0</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="n">Vd</span> <span class="o">=</span> <span class="n">verts_dual</span>
    <span class="n">S0d</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Vd</span><span class="p">))</span>
    <span class="n">S1d</span> <span class="o">=</span> <span class="p">(</span><span class="n">S0d</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">S0d</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="n">P0</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="n">verts</span><span class="p">)</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">integrate_chebyshev</span><span class="p">(</span><span class="n">verts</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="n">P0d</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="n">verts_dual</span><span class="p">)</span>
    <span class="n">P1d</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">integrate_chebyshev_dual</span><span class="p">(</span>
            <span class="n">concatenate</span><span class="p">(([</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">verts_dual</span><span class="p">,</span> <span class="p">[</span><span class="o">+</span><span class="mi">1</span><span class="p">])),</span> <span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">projection</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">P0</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P0d</span><span class="p">,</span> <span class="n">P1d</span>

    <span class="n">B0</span>  <span class="o">=</span> <span class="p">[</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">:</span>  <span class="n">psi0</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="n">B1</span>  <span class="o">=</span> <span class="p">[</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">:</span>  <span class="n">psi1</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">B0d</span> <span class="o">=</span> <span class="p">[</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">:</span> <span class="n">psid0</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">B1d</span> <span class="o">=</span> <span class="p">[</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">:</span> <span class="n">psid1</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="k">def</span> <span class="nf">basis_fn</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">B0</span><span class="p">,</span> <span class="n">B1</span><span class="p">,</span> <span class="n">B0d</span><span class="p">,</span> <span class="n">B1d</span>

    <span class="n">R0</span><span class="p">,</span> <span class="n">R1</span><span class="p">,</span> <span class="n">R0d</span><span class="p">,</span> <span class="n">R1d</span> <span class="o">=</span> <span class="n">reconstruction</span><span class="p">(</span><span class="n">basis_fn</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">boundary_condition</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="n">bc</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">B1d</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">bc</span><span class="p">[</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">f</span><span class="p">(</span><span class="n">xmin</span><span class="p">)</span>
        <span class="n">bc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="n">f</span><span class="p">(</span><span class="n">xmax</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bc</span>

    <span class="n">D0</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">diff</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">D0d</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">diff</span><span class="p">(</span><span class="n">concatenate</span><span class="p">(([</span><span class="mi">0</span><span class="p">],</span> <span class="n">f</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
    <span class="k">def</span> <span class="nf">derivative</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">D0</span><span class="p">,</span> <span class="n">D0d</span>

    <span class="n">H0</span> <span class="o">=</span> <span class="n">H0_cheb</span>
    <span class="n">H1</span> <span class="o">=</span> <span class="n">H1_cheb</span>
    <span class="n">H0d</span> <span class="o">=</span> <span class="n">H0d_cheb</span>
    <span class="n">H1d</span> <span class="o">=</span> <span class="n">H1d_cheb</span>
    <span class="k">def</span> <span class="nf">hodge_star</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">H0</span><span class="p">,</span> <span class="n">H1</span><span class="p">,</span> <span class="n">H0d</span><span class="p">,</span> <span class="n">H1d</span>
    <span class="n">H0</span><span class="p">,</span> <span class="n">H1</span><span class="p">,</span> <span class="n">H0d</span><span class="p">,</span> <span class="n">H1d</span> <span class="o">=</span> <span class="n">hodge_star</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">bunch</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li><a href="../../index.html">dec  documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Dzhelil Rufat.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>